<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Nest Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />
        <!-- Favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg" />
        <!-- Template CSS -->
        <script src="assets/js/vendors/color-modes.js"></script>
        <link href="assets/css/main.css?v=6.0" rel="stylesheet" type="text/css" />
        <!-- <script>
            document.addEventListener('DOMContentLoaded', () => {
                const token = localStorage.getItem('token');
        
                if (!token) {
                    alert('Access denied. Please log in.');
                    window.location.href = '../Admin_dashboard/Frontend/page-account-login.html'; // Redirect to login page
                    return;
                }
        
                // Decode the JWT to verify the user's role
                const decodedToken = decodeJWT(token);
        
                if (!decodedToken || decodedToken.role !== 'client') {
                    alert('Unauthorized access. Clients only.');
                    window.location.href = '../Admin_dashboard/Frontend/page-account-login.html'; // Redirect to login page
                }
            });
        
            // Function to decode the JWT and extract the payload
            function decodeJWT(token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1])); // Decode the payload from the JWT token
                    return payload;
                } catch (error) {
                    console.error('Error decoding JWT token:', error);
                    return null;
                }
            }
        </script> -->
    </head>

    <body>
        <div class="screen-overlay"></div>
        <aside class="navbar-aside" id="offcanvas_aside">
            <div class="aside-top">
                <a href="index.html" class="brand-wrap">
                    <img src="assets/imgs/theme/logo.svg" class="logo" alt="Nest Dashboard" />
                </a>
                <div>
                    <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
                </div>
            </div>
            <nav>
                <ul class="menu-aside">
                    <li class="menu-item active">
                        <a class="menu-link" href="index.html">
                            <i class="icon material-icons md-home"></i>
                            <span class="text">Dashboard</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="page-products-list.html">
                            <i class="icon material-icons md-shopping_bag"></i>
                            <span class="text">Products</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="page-orders-detail.html">
                            <i class="icon material-icons md-shopping_cart"></i>
                            <span class="text">My Orders</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="given-quotation.html">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#878e9a" style="margin-right: 9px;"><path d="m228-240 92-160q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 23-5.5 42.5T458-480L320-240h-92Zm360 0 92-160q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 23-5.5 42.5T818-480L680-240h-92ZM320-500q25 0 42.5-17.5T380-560q0-25-17.5-42.5T320-620q-25 0-42.5 17.5T260-560q0 25 17.5 42.5T320-500Zm360 0q25 0 42.5-17.5T740-560q0-25-17.5-42.5T680-620q-25 0-42.5 17.5T620-560q0 25 17.5 42.5T680-500Zm0-60Zm-360 0Z"/></svg>Quotations</a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="page-transactions-2.html">
                            <i class="icon material-icons md-monetization_on"></i>
                            <span class="text">Transactions</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="customers.html">
                            <i class="icon material-icons md-person"></i>
                            <span class="text">Account</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="page-transactions-2.html">
                            <i class="icon material-icons md-comment"></i>
                            <span class="text">Notifications</span>
                        </a>
                    </li>
                   
                </ul>
                <br />
                <br />
            </nav>
        </aside>
        <main class="main-wrap">
            <header class="main-header navbar">
                <div class="col-search">
                    <form class="searchform">
                        <div class="input-group">
                            <input list="search_terms" type="text" class="form-control" placeholder="Search term" />
                            <button class="btn btn-light bg" type="button"><i class="material-icons md-search"></i></button>
                        </div>
                        <datalist id="search_terms">
                            <option value="Products"></option>
                            <option value="New orders"></option>
                            <option value="Apple iphone"></option>
                            <option value="Ahmed Hassan"></option>
                        </datalist>
                    </form>
                </div>
                <div class="col-nav">
                    <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i class="material-icons md-apps"></i></button>
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link btn-icon" href="#">
                                <i class="material-icons md-notifications animation-shake"></i>
                                <span class="badge rounded-pill">3</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i> </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
                        </li>
                        <li class="dropdown nav-item">
                            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownLanguage" aria-expanded="false"><i class="material-icons md-public"></i></a>
                            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
                                <a class="dropdown-item text-brand" href="#"><img src="assets/imgs/theme/flag-us.png" alt="English" />English</a>
                                <a class="dropdown-item" href="#"><img src="assets/imgs/theme/flag-fr.png" alt="Français" />Français</a>
                                <a class="dropdown-item" href="#"><img src="assets/imgs/theme/flag-jp.png" alt="Français" />日本語</a>
                                <a class="dropdown-item" href="#"><img src="assets/imgs/theme/flag-cn.png" alt="Français" />中国人</a>
                            </div>
                        </li>
                        <li class="dropdown nav-item">
                            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img class="img-xs rounded-circle" src="assets/imgs/people/avatar-2.png" alt="User" /></a>
                            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                                <a class="dropdown-item" href="#"><i class="material-icons md-perm_identity"></i>Edit Profile</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account Settings</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-account_balance_wallet"></i>Wallet</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help center</a>
                                <div class="dropdown-divider"></div>
                                <button id="logout" class="dropdown-item text-danger"><i class="material-icons md-exit_to_app"></i>Logout</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </header>
            <section class="content-main">
                <div class="row">
                    <div class="col-9">
                        <div class="content-header">
                            <h2 class="content-title">Create Quotation</h2>
                            <!-- <button id="add-product-button" class="btn btn-md rounded font-sm hover-up">Send</button> -->
                        </div>
                    </div>
                    <form id="quoteForm" style="max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f7f7f7; border-radius: 10px; font-family: Arial, sans-serif; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);">
                        <h2 style="text-align: center; margin-bottom: 20px; font-size: 24px; color: #333;">Quotation Form</h2>
                      
                        <!-- Client Field -->
                        <label for="client" style="display: block; margin-bottom: 5px; font-weight: bold; color: black;;">Client Name:</label>
                        <input type="text" id="client" name="client" placeholder="Enter client name" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #bab6b6">

                        <!-- Client unique code(mongodb code) -->
                        <label for="clientCode" style="display: block; margin-bottom: 5px; font-weight: bold; color: black;">Client Code:</label>
                        <input type="text" id="client-code" name="client-code" placeholder="Client Code" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #bab6b6;">
                      
                        <!-- Quote Code Field -->
                        <label for="quoteCode" style="display: block; margin-bottom: 5px; font-weight: bold; color: black;">Quote Code:</label>
                        <input type="text" id="quoteCode" name="quoteCode" placeholder="Enter quote code" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #bab6b6;">
                      
                        <!-- Quote Date Field -->
                        <!-- <label for="quoteDate" style="display: block; margin-bottom: 5px; font-weight: bold; color: black">Quote Date:</label>
                        <input type="date" id="quoteDate" name="quoteDate" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #bab6b6;"> -->
                      
                        <!-- Due Date Field -->
                        <label for="dueDate" style="display: block; margin-bottom: 5px; font-weight: bold; color: black">Due Date:</label>
                        <input type="date" id="dueDate" name="dueDate" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;">
                      
                        <!-- Product Rows Section -->
                        <div id="productRows" style="margin-bottom: 20px; color: black">
                            <strong>Products:</strong>
                          <!-- Default Product Row -->
                          <div class="product-row" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <select class="productSelect" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                              <!-- <option value="" disabled selected>Loading products...</option> -->
                            </select>
                            <input type="text" placeholder="Properties" class="propertiesField" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <button type="button" class="deleteRow" style="padding: 5px 10px; background-color: #dc3545; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Delete</button>
                          </div>
                        </div>
                      
                        <!-- Add Product Row Button -->
                        <button type="button" id="addRowButton" style="width: 100%; padding: 12px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-bottom: 15px;">
                          Add Product Row
                        </button>
                      
                        <!-- Notes Field -->
                        <label style="display: block; margin-bottom: 5px; color: black">Notes:</label>
                        <textarea id="notes" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                      
                        <!-- Terms Field -->
                        <label style="display: block; margin-bottom: 5px; color: black">Terms:</label>
                        <textarea id="terms" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                      
                        <!-- Submit Button -->
                        <button type="submit" style="width: 100%; padding: 12px; background-color: #28a745; color: #fff; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                          Submit
                        </button>
                      </form>
                      
                      

                      
                      
                      <template id="productRowTemplate">
                        <div class="product-row" style="margin-bottom: 10px;">
                          <select class="product-select" style="width: 200px; padding: 5px; margin-right: 10px; border-radius: 5px;">
                            <option value="" disabled selected>Select Product</option>
                            <!-- Products will be populated here -->
                          </select>
                          <input type="text" class="product-details" placeholder="Details" style="width: 200px; padding: 5px; margin-right: 10px; border: 1px solid #ccc; border-radius: 5px;">
                          <input type="number" class="product-price" placeholder="Price" style="width: 100px; padding: 5px; margin-right: 10px; border: 1px solid #ccc; border-radius: 5px;">
                          <button type="button" class="delete-row" style="padding: 5px 10px; background-color: #dc3545; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Delete</button>
                        </div>
                      </template> 
                </div>
            </section>
            <footer class="main-footer font-xs">
                <div class="row pb-30 pt-15">
                    <div class="col-sm-6">
                        <script>
                            document.write(new Date().getFullYear());
                        </script>
                        &copy; Nest - HTML Ecommerce Template .
                    </div>
                    <div class="col-sm-6">
                        <div class="text-sm-end">All rights reserved</div>
                    </div>
                </div>
            </footer>
        </main>
        <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="assets/js/vendors/select2.min.js"></script>
        <script src="assets/js/vendors/perfect-scrollbar.js"></script>
        <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
        <!-- Main Script -->
        <script src="assets/js/main.js?v=6.0" type="text/javascript"></script>

<!-- dynamically filling the clients detaild -->
<script>
    let Email
    let Profile
    function getJWTToken() {
        return localStorage.getItem('token'); // Retrieve JWT from localStorage
    }
    
    // Function to decode JWT token and safely extract clientId
    function decodeJWT(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1])); // Decode the payload from the JWT token
            console.log(payload)
            return payload.id; // Extract client ID or user ID from the payload
        } catch (error) {
            console.error('Error decoding JWT token:', error);
            return null;
        }
    }
    
    // Function to fetch client details by clientId from the API
    async function fetchClientDetails(clientId) {
        const apiUrl = `http://localhost:8000/clients/by-id-client/${clientId}`;
        
        try {
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getJWTToken()}`, // Include JWT in the request header
                },
            });
            
            const data = await response.json();
            console.log("client is ->",data.client)

            
            // Check if the response is successful and contains client data
            if (response.ok && data.success && data.client) {
                // Assuming the client object has a 'name' property or similar
                document.getElementById('client-code').value = data.client.CustomerId; // Adjust based on actual property name
                document.getElementById('client').value = data.client.FirstName + " " + data.client.LastName; // Adjust based on actual property name 
                document.getElementById('client').setAttribute('readonly', 'readonly');

                Email = data.client.Email
                Profile = data.client.Profile

                const getRandomLetter = () => {
                    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    return letters.charAt(Math.floor(Math.random() * letters.length));
                    };
                const getRandomNumber = () => {
                    return Math.floor(Math.random() * 100);
                    };
                const getFinalLetter = () => {
                    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    return letters.charAt(Math.floor(Math.random() * letters.length));
                    };
                const lettersPart = getRandomLetter() + getRandomLetter();
                const numberPart = getRandomNumber().toString().padStart(2, '0');
                const finalLetter = getFinalLetter();
                const QuoteCode = 'Q' + lettersPart + numberPart + finalLetter;
                document.getElementById('quoteCode').value = QuoteCode
                document.getElementById('quoteCode').setAttribute('readonly', 'readonly');

                // const currentDate = new Date().toISOString().split('T')[0]; // Get current date in 'YYYY-MM-DD' format
                // document.getElementById('quoteDate').value = currentDate; 
                // document.getElementById('quoteDate').setAttribute('readonly', 'readonly');


            } else {
                console.error('Client not found or invalid response:', data.message);
                alert('Client not found. Please check your request or contact support.');
            }
        } catch (error) {
            console.error('Error fetching client information:', error);
            alert('Error fetching client information. Please try again later.');
        }
    }
    
    // Function to initialize the client code input field and make the API request
    function initializeClientCode() {
        const jwt = getJWTToken();
        
        if (!jwt) {
            console.error('JWT token not found in localStorage');
            alert('You must be logged in to access this page.');
            window.location.href = '../Admin_dashboard/Frontend/page-account-login.html'; // Redirect to login if no token
            return;
        }
    
        const clientId = decodeJWT(jwt);
        
        if (!clientId) {
            console.error('Client ID not found in the token');
            alert('Error with the JWT token. Please log in again.');
            window.location.href = '../Admin_dashboard/Frontend/page-account-login.html'; // Redirect to login if clientId is missing
            return;
        }
    
        // Set the client code input field to the clientId and make it read-only
        const clientCodeInput = document.getElementById('client-code');
        clientCodeInput.setAttribute('readonly', 'readonly'); // Make input field read-only
    
        // Fetch client details using the clientId and populate the input field
        fetchClientDetails(clientId);
    }
    
    // Initialize client code input field when the page loads
    window.onload = initializeClientCode;
     </script>


        
        <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Fetching products from the API
    fetch("http://localhost:8000/products/getProduct/getAll")
      .then(response => response.json())
      .then(data => {
        // Populate the first product select input with products
        const productSelectElements = document.querySelectorAll('.productSelect');
        const products = data.products; // Assuming the response contains a 'products' array
        productSelectElements.forEach(selectElement => {
          products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.ProductTitle; // Assuming the product has an 'id'
            option.textContent = product.ProductTitle; // Assuming the product has a 'name'
            selectElement.appendChild(option);
          });
        });
      })
      .catch(error => console.error('Error fetching products:', error));

    // Add Product Row
    document.getElementById("addRowButton").addEventListener("click", () => {
      const productRowsContainer = document.getElementById("productRows");

      const newRow = document.createElement("div");
      newRow.classList.add("product-row");
      newRow.style.display = "flex";
      newRow.style.alignItems = "center";
      newRow.style.gap = "10px";
      newRow.style.marginBottom = "15px";

      // Product Select Input
      const productSelect = document.createElement("select");
      productSelect.classList.add("productSelect");
      productSelect.style.flex = "1";
      productSelect.style.padding = "10px";
      productSelect.style.border = "1px solid #ccc";
      productSelect.style.borderRadius = "5px";
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.disabled = true;
      defaultOption.selected = true;
      defaultOption.textContent = "Select Product";
      productSelect.appendChild(defaultOption);

      // Properties Input Field
      const propertiesField = document.createElement("input");
      propertiesField.type = "text";
      propertiesField.placeholder = "Properties";
      propertiesField.classList.add("propertiesField");
      propertiesField.style.flex = "1";
      propertiesField.style.padding = "10px";
      propertiesField.style.border = "1px solid #ccc";
      propertiesField.style.borderRadius = "5px";

      // Delete Button for this row
      const deleteButton = document.createElement("button");
      deleteButton.type = "button";
      deleteButton.classList.add("deleteRow");
      deleteButton.style.padding = "5px 10px";
      deleteButton.style.backgroundColor = "#dc3545";
      deleteButton.style.color = "#fff";
      deleteButton.style.border = "none";
      deleteButton.style.borderRadius = "5px";
      deleteButton.style.cursor = "pointer";
      deleteButton.textContent = "Delete";
      deleteButton.addEventListener("click", () => {
        newRow.remove();
      });

      newRow.appendChild(productSelect);
      newRow.appendChild(propertiesField);
      newRow.appendChild(deleteButton);

      productRowsContainer.appendChild(newRow);

      // Re-fetch products when new row is added to populate the select input
      fetch("http://localhost:8000/products/getProduct/getAll")
        .then(response => response.json())
        .then(data => {
          const productSelect = newRow.querySelector('.productSelect');
          data.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.ProductTitle;
            option.textContent = product.ProductTitle;
            productSelect.appendChild(option);
          });
        });
    });

    // Handle form submission
    document.getElementById("quoteForm").addEventListener("submit", (event) => {
      event.preventDefault(); // Prevent form submission

      // Collecting form data
      const client = document.getElementById("client").value;
      const clientCode = document.getElementById("client-code").value;
      const quoteCode = document.getElementById("quoteCode").value;
    //   const quoteDate = document.getElementById("quoteDate").value;
      const dueDate = document.getElementById("dueDate").value;
      const notes = document.getElementById("notes").value;
      const terms = document.getElementById("terms").value;

      const products = [];
      const productRows = document.querySelectorAll(".product-row");

      productRows.forEach(row => {
  const productSelect = row.querySelector(".productSelect");
  const propertiesField = row.querySelector(".propertiesField");

  if (productSelect.value && propertiesField.value) {
    products.push({
      ProductTitle: productSelect.value, // Ensure this matches the backend field
      properties: propertiesField.value, // Ensure this matches the backend field
    });
  }
});


      // Prepare data for submission
      const formData = {
        client,
        quoteCode,
        clientCode,
        Email,
        Profile,
        // quoteDate,
        dueDate,
        notes,
        terms,
        products, // Array of product objects with properties
      };
console.log(formData)
      // Sending data to the database (example API request)
      fetch('http://localhost:8000/quotes/submit-quote', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      })
        .then(response => response.json())
        .then(data => {
          alert("Quotation submitted successfully!");
          console.log(data);
        })
        .catch(error => {
          alert("Error submitting quotation!");
          console.error(error);
        });
    });
  });
</script>








<script>
    document.getElementById('logout').addEventListener('click', function () {
// Remove the token from localStorage
localStorage.removeItem('token');

// Alert user about successful logout
alert('You have been logged out successfully!');

// Redirect to login page
window.location.href = '../Admin_dashboard/Frontend/page-account-login.html'; // Redirect to login page after logout
});
</script>
    </body>
</html>